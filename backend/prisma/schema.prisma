// Prisma schema for EternLink Dead Man's Switch

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table - stores user account information
model User {
  id                    String       @id @default(uuid())
  walletAddress         String?      @unique @map("wallet_address") @db.VarChar(42)
  email                 String       @unique @db.VarChar(255)
  passwordHash          String       @map("password_hash") @db.VarChar(255)
  emailVerified         Boolean      @default(false) @map("email_verified")
  phoneNumber           String?      @map("phone_number") @db.VarChar(20)
  phoneVerified         Boolean      @default(false) @map("phone_verified")
  voiceSignature        String?      @map("voice_signature") @db.Text // Base64 encoded voice recording
  accountFrozen         Boolean      @default(false) @map("account_frozen")
  freezeReason          String?      @map("freeze_reason") @db.VarChar(255)
  lastLoginAt           DateTime?    @map("last_login_at")
  emailNotificationDays Int?         @map("email_notification_days") // Days before email notification
  phoneNotificationDays Int?         @map("phone_notification_days") // Days before phone notification
  freezeDays            Int?         @map("freeze_days") // Days before account freeze
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  heartbeats            Heartbeat[]
  verificationCodes     VerificationCode[]
  loginHistory          LoginHistory[]

  @@index([email])
  @@index([lastLoginAt])
  @@map("users")
}

// Verification codes for email/phone verification
model VerificationCode {
  id            String    @id @default(uuid())
  userId        String?   @map("user_id")
  email         String?   @db.VarChar(255)
  phoneNumber   String?   @map("phone_number") @db.VarChar(20)
  code          String    @db.VarChar(6)
  type          String    @db.VarChar(20) // email_verification, phone_verification, password_reset
  expiresAt     DateTime  @map("expires_at")
  verified      Boolean   @default(false)
  createdAt     DateTime  @default(now()) @map("created_at")

  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([phoneNumber])
  @@index([code])
  @@index([expiresAt])
  @@map("verification_codes")
}

// Login history for tracking user activity
model LoginHistory {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  loginAt       DateTime  @default(now()) @map("login_at")
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent") @db.Text
  loginMethod   String    @map("login_method") @db.VarChar(50) // password, siwe, voice

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginAt])
  @@map("login_history")
}

// Heartbeats table - tracks user check-ins and encrypted shares
model Heartbeat {
  id                  String        @id @default(uuid())
  userId              String        @map("user_id")
  lastCheckIn         DateTime      @map("last_check_in")
  intervalDays        Int           @map("interval_days") // 30, 60, 90, 180
  encryptedFileHash   String        @map("encrypted_file_hash") @db.VarChar(66) // 0x...
  shareOneEncrypted   String        @map("share_one_encrypted") @db.Text // Encrypted SSS Share 1 (user keeps)
  shareThreeEncrypted String        @map("share_three_encrypted") @db.Text // Encrypted SSS Share 3 (stored on blockchain/metadata)
  recoveryTriggered   Boolean       @default(false) @map("recovery_triggered")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  beneficiaries       Beneficiary[]
  notificationLogs    NotificationLog[]

  @@index([userId])
  @@index([lastCheckIn])
  @@map("heartbeats")
}

// Beneficiaries table - stores beneficiary information and Share 2
model Beneficiary {
  id                String    @id @default(uuid())
  heartbeatId       String    @map("heartbeat_id")
  name              String    @db.VarChar(255)
  email             String    @db.VarChar(255)
  relationship      String?   @db.VarChar(100)
  shareTwoEncrypted String    @map("share_two_encrypted") @db.Text // Encrypted SSS Share 2
  notifiedAt        DateTime? @map("notified_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  heartbeat         Heartbeat @relation(fields: [heartbeatId], references: [id], onDelete: Cascade)
  notificationLogs  NotificationLog[]

  @@index([heartbeatId])
  @@index([email])
  @@map("beneficiaries")
}

// Notification logs - tracks email notifications sent to beneficiaries
model NotificationLog {
  id              String    @id @default(uuid())
  heartbeatId     String    @map("heartbeat_id")
  beneficiaryId   String    @map("beneficiary_id")
  sentAt          DateTime  @default(now()) @map("sent_at")
  emailStatus     String    @map("email_status") @db.VarChar(50) // sent, failed, bounced
  emailProviderId String?   @map("email_provider_id") @db.VarChar(255)
  errorMessage    String?   @map("error_message") @db.Text

  heartbeat       Heartbeat  @relation(fields: [heartbeatId], references: [id], onDelete: Cascade)
  beneficiary     Beneficiary @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)

  @@index([heartbeatId])
  @@index([beneficiaryId])
  @@index([sentAt])
  @@map("notification_logs")
}
